# TCRank mechanics

## Постановка задачи:

Задачей является создание инструмента, для создания ранжированного списка, управляемого кураторами, чей вес определяется персональными балансами некоторого токена. В данной части мы оставим за пределами рассмотрения макроэкономику токена (внешний курс и ценность как платежного актива). В децентрализованных системах баланс токена представляет собой в первую очередь прекрасный математический инструмент, позволяющий использовать его в алгоритмах, которые представляют собой экономические игры, составленные по правилам, которые должны давать выигрыш при полезных общественных действиях и проигрыш при плохих. Для этого класса игр уже многое изучено экономистами и смарт-контракты дают им в руки прекрасный инструмент для создания автоматизированных экономик с полной прозрачностью и прекрасным качеством данных. Одной из основ таких экономик будут являться алгоритмы децентрализованного курирования. Это специальный класс алгоритмов, призванных обеспечить максимально приближенное к пожеланиям людей управление списками различных объектов и их ранжированием.  

В системах курирования токен является в первую очередь активом в экономической игре с нулевой или ненулевой суммой, в которой выгодно действовать, улучшая качество ранжирования, и невыгодно портить его. Надо помнить, что мы решаем задачу создания честного по человеческим, а не по инжененым метрикам списка, а это означает, что алгоритм должен реализовывать что то, близкое к естественному поведению людей в социуме. Т.е алгоритм должен моделировать ограничения и допущения, к которым привыкли люди, оценивая различные факты вокруг нас в реальной жизни. Поэтому в таких системах токен должен быть крайне непохож на финансовый инструмент, т.к. в большой степени зависит от общественного мнения кураторов и может обладать дополнительными свойствами или ограничениями. Собственно назвать это число токеном нас вынуждает только широкое рапространение инструментов по работе со стандартными интерфейсами контрактов и удобство в эксплуатации.

Решение задачи простроения ранжированного списка и управления уже предлагалось в нескольких вариантах, это, к примеру, консенсус DPoS, или модификация TCR названная как "graded TCR". В этих алгоритмах куратор "замораживает" некоторый баланс токенов "во имя" объекта, за который он голосует. Позиция объекта в рейтинге определяется суммой "голосов", поданных за объект. Эта схема с определенными ограничениями вполне работоспособна для построения небольших списков, проста и удобна в эксплуатации. Однако, если говорить о "human-curated rankings", то эти схемы не решают проблем, которым подвершен процесс курирования некоторго списка и его восприятие пользователями.

Чтобы перейти к самой модели, давайте опишем проблемы вышеописанных ранжирований:


1) Проблема "big stake" - это проблема голосования большим стейком токенов. Обладатель большого количества токенов может практически мгновенно перебрасывать свои голоса между интересующими его объектами, резко опуская и поднимая их в рейтинге. Даже если не брать во внимание злонамеренное использование своего стейка, такие резкие манипуляции с ранжированным списком вряд ли будут ценными для пользователей, т.к. не будут обладать хотя бы краткосрочной предсказуемостью. В случае же злонамеренной активности обладатель большого количества токенов может легко сделать список неработоспособным, вбрасывая и выбрасывая из него случайные объекты. Для работы с данной проблемой алгоритм курирования должен делать подобную активность невыгодной или рискованной.

2) Проблема "sybil stakes" - это так называемые "sybil" атаки, проводимые согласованными действиями большого числа аккаунтов-ботов. Даже если наш алгоритм справился с предыдущей проблемой "китов" (например введя ограничения на размер голосующего стейка или введя штрафы за массивные операции) то этого все равно недостаточно, чтобы защититься от большого стейка, разделенного на большое количество малых частей, действующих согласованно. Это одна из самый серьезных проблем децентрализованных алгоритмов, которую часто недооценивают, т.к. на данный момент такие атаки являются нерентабельными для атакующих, а блокчейн приложения пока не могут предложить атакующим серьезных наград за массивные автоматизированные действия. Но как только ранжирование станет представлять серьезную ценность, они могут стать крайне актуальными (в качестве примера стоит привести Steemit и Golos). Неизменные ограничения-константы, накладываемые на операции не являются хорошим решением для защиты от подобных атак, поэтому сама модель должна делать невыгодными действия согласованного набора sybil-аккаунтов. 

3) Проблема "nothing at stake". Она свойственна всем системам, где участники оперируют балансами токенов для получения прибыли, и является фундаментальной. Любая система, которая за некоторое действие всегда гарантированно награждает участников обязательно подвержена этой атаке. Если в системе есть действие, за которое всегда выплачивается вознаграждение, то в этом случае возможно создание бота, который выполняет строго это действие, за которое получает пусть небольшое, но гарантированное вознаграждение. В этом случае система за счет ботов получает перекос в сторону действий, приносящих доход, и становится бесполезной. Для защиты от этого типа атак модель обязательно должна реализовывать некоторую экономическую игру с нулевой суммой, задача которой - сделать бессмысленными массивные согласованные действия, а если они и имеют место, эффект от них должен быть эквивалентен простому random-ному угадыванию.

4) Проблема "lazy stake" - проблема бездействия куратора. Эта проблема имеет место при старте нового ранжирования, когда объектов много, а кураторов мало. В этом случае алгоритм должен стимулировать кураторов к более активным действиям для выстраивания сбалансированного рейтинга, но не превращая курирование в механический и бездумный процесс. Учитывая, что кураторы - это люди, а деятельность людей желательно стимулировать мягко и без принуждения, эта задача также является крайне непростой в решении, ибо человеческая деятельность носит нерегулярный характер, неравномерно распределена по времени и зависит от непредсказуемых факторов. Значит модель должна уметь ускорять процессы при затухании активности кураторов и наоборот, замедлять движение при активной работе кураторов, приводя систему в равновесие.

5) Проблема "init stake" - это проблема "холодного старта". Запуск курирования некоторого реестра означает первоначальное распределение токена, которое может быть случайным, либо наоборот, слишком специфичным. Это может быть распределение токена между несколькими экспертами, или распределение между большим количеством случайных кураторов. В обоих случаях модель должна работать эффективно при любых количествах участников, стимулируя курирование на старте системы и постепенно требуя все меньше активных действий от кураторов реестра по мере его "взросления".  

6) Проблема простоты и доступности представления. Создавая систему для людей необходимо, чтобы она была понятной, предсказуемой и давала правильную обратную связь. Совершенно необходимо уметь доступно и просто показать результаты работы кураторов и общее состояние системы, а в случае динамических систем эта задача довольно сложна, т.к. должна быть одновременно простой, но при этом уметь показывать сразу несколько серий данных и потенциальных исходов действий куратора. Создание качественных элементов управления для этой задачи, понятных рядовому пользователю, и одновременно обладающих достаточной полнотой для высокоточного управления курированием мы считаем также серьезным вызовом для создания работоспособных ранжирований. 


Мы считаем что текущие модели, которые оперируют абсолютными значениями баланса и позволяют голосовать за отдельные объекты просто заморозкой нужного числа токенов (gTCR, DPoS) слабо устойчивы к вышеописанным проблемам и особенно плохо применимы к ранжированиям, имеющим человеческую, а не алгоритмическую, ценность. Мы предлагаем свое решение, с более сложным процессом взаимодействия с реестром, чей алгоритм старается свести вышеописанные проблемы к минимуму.
 
Наш подход является попыткой перейти от схем, использующих абсолютные значения к схемам, в которых учитывается динамическое поведение, а не статический снимок системы. Т.е. где основные переменные зависят не только от глобальных параметров, но и от того, насколько быстро или медленно происходят процессы внутри системы. В природе вокруг нас множество систем, которые естественным образом регулируются именно с помощью динамических параметров, начиная от внутриклеточных реакций и до биоценоза. В таких системах мы наблюдаем динамическое равновесие, которое обеспечивается несогласованными действиями множества участников, и где скорость реакций является важнейшим параметром, который связан со всеми процессами в системе. Мы надеемся, что этот подход позволит создать столь же устойчивые к внешним воздействиям алгоритмы, построенные так, чтобы всегда стремиться к равновесию и регулироваться естественным образом.


## Основная схема работы реестра TCRank

Первым важным свойством предлагаемого алгоритма является динамическая модель. Это означает, что любое действие в реестре растянуто по времени, и продолжается некоторое время, а каждое действие куратора меняет не вертикальную координату объекта (как в схеме с простым голосованием стейком), а сообщает объекту некоторый импульс, после чего объект некоторое время движется, меняя свою позицию в ранжированном реестре. Физической аналогией модели могут являться тела, погруженные в жидкость, которые, получив импульс от куратора, всплывая или погружаясь занимают различные позиции на шкале глубины. Куратор, пытаясь сдвинуть объект, использует некоторое количество токенов, чтобы предсказать направление итогового импульса. По результатам голосования кураторов по заданному объекту определяется итоговый импульс, который и двигает объект в нужном направлении. Зависимость координаты от времени при этом может быть нелинейной или ограниченной. Это свойство должно позволить сделать действия куратора наиболее выгодными лишь в диапазоне, который возвращает систему в состояние равновесия. Действия, вносящие дисбаланс должны в свою очередь быть менее выгодными - это позволит системе автоматически возвращаться в состояние динамического равновесия. Мы считаем, что подобное приближение к естественным физическим моделям позволит нашему алгоритму лучше сопротивляться вредным воздействиям, а также быть более наглядным и понятным для кураторов. Также, при правильном подборе параметров системы и обратной связи от системы, реестр сможет автоматически стремиться к оптимальной скорости изменений, стимулируя движение объектов при слабой активности и замедляя процессы при слишком интенсивном использовании.

Вторым свойством предлагаемой модели является обязательная обратная связь между характером движения объектов и параметрами системы, такими как награды и штрафы кураторов, характер движения объектов, ограничения на количество действий в системе и другими параметрами, влияющими на равновесие процессов. Мы планируем постепенно усложнять обратные связи в модели, пытаясь:

скомпенсировать проблему "init stake", усиливая скорость изменений в начальном состоянии реестра, когда объекты неотранжированы и требуется высокая профитность и точность предсказания направления импульса высока (в большинстве случаев - вверх), и замедляя активность, когда реестр уже обладает большим количеством активных кураторов с небольшим стейком, и не должен демонстрировать резкие изменения
скомпенсировать проблему  "big stake", увеличивая стоимость голосования, размеры комиссий и другие параметры, делающие операции массивным стейком невыгодными, но только после того, как реестр изначально настроится, т.к. на начальных этапах небольшое число кураторов с массивными балансами токенов - это нормально
при всех этих действиях важно максимально соблюсти равновесие между рисками и профитностью для кураторов, чтобы максимально смягчить проблему "sybil stake", стараясь оставить автоматизированным ботам единственную стратегию - чисто random-ное поведение, которое минимально вредит реестру


## Описание базового алгоритма


### Терминология
Куратор: адрес, обладающий некоторым балансом курирующего токена, от имени которого проводятся транзакции в контракт HCR

Challenge: процедура голосования за некоторый факт(такой как включение в реестр нового объекта, или придание импульса объекту в реестре). В v1 планируется использовать простое commit-reveal голосование, так, чтобы кураторы не могли бы до окончания challenge предсказать итоговый импульс объекта. В будущих версиях, с целью затруднения атак "sybil stake" возможен переход к zero-knowledge вариантам анонимных голосований и псевдослучайной генерацией наград и штрафов за курирование вплоть до полностью анонимного голосующего токена.

Импульс: число со знаком, определяющее силу и направление, с которой куратор хочет сдвинуть объект с его позиции в реестре. В момент, когда результирующий импульс для объекта определен, в самом объекте фиксируется время и значение импульса. С этого момента  можно вычислить положение объекта в любой момент времени согласно уравнению движения.

### Включение в реестр и исключение из него

Включение нового объекта  или исключение старого выполняется куратором, с использованием стандартного TCR. Находящийся в реестре объект требует заморозки определенного числа токенов, разморозить которые можно только исключив объект из реестра. Токены заморожен все время, пока объект находится в списке.

Для включения объекта в реестр (или его исключения) куратор отправляет в контракт "заявку", которую может оспорить любой другой куратор, запустив challenge протокол. После окончания challenge объект добавляется или удаляется из реестра только в случае, если голосующие проголосовали “за”. Победившая часть голосующих делит между собой стейк инициатора протокола или создателя challenge.



### Придание импульса объекту
Эта процедура является основной в модели. Когда куратор хочет поднять или опустить объект в реестре, он запускает challenge-протокол, состоящий из нескольких фаз, близких по смыслу к традиционной “commit-reveal” схеме.

 1. Фаза “commit”. Куратор объявляет новый challenge по заданному объекту, одновременно внося первый голос за него, отправляя в скрытом виде число токенов, которыми он голосует и направление импульса. Мы будем обозначать голосующий стейк как Si, и иметь в виду, что это число со знаком, т.к. импульс может быть положительным или отрицательным в зависимости от желаемого направления движения объекта. Другие кураторы присоединяются к голосованию, отправляя свои стейки и направления импульсов (S1 .. Sn), также в скрытом виде. Каждый commit сопровождается некоторой комиссией, которая будет потеряна куратором в случае неисполнения протокола. 

 2. Фаза “reveal”. После некоторого промежутка времени, каждый куратор должен опубликовать значение импульса.  У куратора на этот момент должно быть достаточно токенов на балансе, чтобы их заморозить, иначе он теряет комиссию, а его импульс не учитывается. Все открытые импульсы суммируются, вычисляется итоговый импульс (вверх или вниз) и в объекте фиксируется время принятия решения и результирующий импульс. 

 3. Фаза “movement”. С момента “reveal” считается, что объект получил импульс, и теперь его скорость и положение будут меняться каждую секунду в зависимости от приложенного импульса. Скорость объекта удобно измерять в “токенов/сек”, а его позиция в реестре будет определяться его координатой в требуемый момент времени в зависимости от заданного уравнения движения. Таким образом импульс влияет на финальную координату объекта (где он окажется в результате движения), а также скорость возврата вложенных кураторами в движение стейков.
В момент начала движения объекта все участвовавшие в голосовании стейки кураторов замораживаются, и доступ к этим токенам кураторы получают постепенно, по мере движения объекта. Кураторы, постепенно возвращают себе токены, но лишь частями по мере движения объекта по реестру.  Правильно предсказавшие направление импульса кураторы получают суммарно больше токенов, а проигравшие - меньше. Необходимая разница для обеспечения наградой победителей забирается из голосующего стейка проигравших. В конечный момент движения, кураторам возвращаются все замороженные токены с учетом выигрыша или проигрыша.


Таким образом, взаимодействие кураторов с системой представляет собой процесс, состоящий из следующих шагов:
 1. куратор выбирает объект, который по его мнению заслуживает более высокого или более низкого положения в рейтинге
 2. куратор оценивает свой баланс токенов, оценивает риск не сойтись во мнении с другими кураторами и, оценивая риск проигрыша, подбирает размер стейка
 3. куратор стартует “movement challenge”, зафиксировав криптографический хеш от отправляемого импульса (стандартная схема “commit-reveal”).
 4. другие кураторы, желающие присоединиться к challenge размещают свои commit-ы импульсов
 5. после прохождения окончания фазы commit, кураторы начинают открывать свои импульсы (фаза "reveal")
 6. после окончания фазы “reveal” объект начинает движение, стейки постепенно возвращаются кураторам, при этом победителям возвращается больше токенов, чем проигравшим


Все кураторы (включая и первого) платят некоторую комиссию за участие в голосовании. Эта комиссия будет возвращена тем, кто успешно раскрыл свои импульсы. Комиссия необходима чтобы сделать невыгодным саботирование протокола путем голосования без последующего открытия своего голоса. 

В этой базовой схеме есть проблема того, что куратор может оценить свои шансы на выигрыш и понять, что ему дешевле заплатить комиссию, чем участвовать в заведомо проигрышном голосовании. Эта часть является крайне интересной, и мы планируем в будущем заменить простой “commit-reveal” на наиболее подходящую схему анонимного голосования, возможно совместив ее с псевдо-случайно сгенерированным размером комиссий и наград. Эти действия необходимы для того, чтобы ограничить выбор стратегий ботов

Такая “инерционная” механика возврата стейка представляет собой в некотором роде prediction market, в котором награда за успешный прогноз начисляется не сразу, а поэтапно с течением времени. Такая механика не позволяет быстро перебрасывать стейк с одного объекта на другой, в связи с чем автоматические средства не будут иметь существенного преимущества в скорости принятия решений по сравнению с человеком, и курировать реестр в такой системе лично должно быть более выгодно, чем использовать автоматизированного бота.

Алгоритм начисления награды/штрафа за курирование и взятия комиссии за голосование является ядром всей системы ранжирования и является нашей основной разработкой. Мы понимаем, что угадать все типы зависимостей и константы (скорость выплат от времени, размер комиссии, размер штрафа за неверное предсказание и многие другие) нереально, поэтому планируем моделировать различные соотношения, стараясь сделать модель максимально затрудняющую атаки, использующие все вышеописанные проблемы TCR. Этот алгоритм на этапе разработке будет в первую очередь пердставлен в открытом исходном коде, а после получения значимых результатов - в технической части whitepaper.


## Имплементация TCRank

Так как задачей является построение рабочей системы, для работы мы выбрали объекты, работа с которыми может быть интересна нашей целевой аудитории - людям, интересующимися децентрализованными сетями и DApp-ами. Эти объекты -  сами DApp-ы. Помимо явного интереса к теме очень важным фактором при выборе было то, что эта аудитория в полной мере владеет необходимыми инструментами для работы с публичными блокчейнами. Неразвитость клиентского софта и неумение им пользоваться является на данный момент серьезным препятствием для развития децентрализованных алгоритмов курирования, и мы надеемся, что наши кураторы своими действиями существенно улучшат качество децентрализованного софта, давая честную обратную связь разработчикам.

Мы собираемся: 

 - реализовать первую версию алгоритмa TCRank, тесты для него, и код для моделирования экономичеcкой модели
 - запустить каталог DApp-ов, цель которого - вывод информации по наиболее релевантным с точки зрения кураторов DApp-ам
 - подготовиться к полному циклу “разработка-тестирование-выкладка-обратная связь” в основной и тестовой сети
 - запустить процесс курирования и начать сбор метрик для оценки качества модели
 - анализировать работу TCRank и настраивать модель для успешного противодействия описанным выше атакам
 - рекомендовать кураторам и самим проводить тестовые атаки на алгоритм с целью его доработки, публикуя результаты
 - если задача потребует сравнения нескольких предметных областей, сформировать несколько рейтингов, управляемых экспертами и комьюнити, которые реализуют различные варианты алгоритма курирования TCRank
 - разработать и выложить в открытый доступ конструкторы контрактов TCRank и средства для запуска и курирования произвольных реестров
 - зафиксировать результаты в TCRank версии 1.0

